<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lesson 7-1</title>
  <style>
    :root{
      --game-w: 1000px; /* 固定遊戲寬 */
      --game-h: 720px;  /* 固定遊戲高 */
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background-color: #fdf6e3;
    }

    /* 背景鋪滿；外層只負責置中與縮放 */
    body {
      background-image: url('background.png');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center top;
    }

    /* ★ 新增外層：固定把整個遊戲當成一個「盒」來縮放 */
    .stage-outer{
      width: 100vw;
      height: 100svh;               /* 行動裝置安全視高 */
      display: flex;
      justify-content: center;       /* 水平置中 */
      align-items: flex-start;       /* 置頂（底部自然留白） */
      overflow: hidden;              /* 不出捲軸 */
    }

    .container {
      transform-origin: top center;  /* 以「頂部中央」為縮放基準 */
      width: var(--game-w);
      height: var(--game-h);
      transform: scale(1);           /* 桌面 1:1 顯示，手機由 JS 動態改 */
      display: block;
    }

    .game-row {
      display: flex;
      gap: 20px;
    }

    .left-panel { width: 192px; }

    select {
      width: 192px;
      font-size: 16px;
      padding: 5px;
      color: #8B4513;
      background-color: white;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }

    .label {
      color: #8B4513;
      font-size: 16px;
      margin: 8px 0 4px;
      text-align: left;
      font-weight: normal;
    }

    .keyboard { display: flex; flex-wrap: wrap; width: 192px; }

    .keyboard button {
      width: 60px;
      height: 60px;
      margin: 2px;
      font-size: 24px;
      background-color: #8B4513;
      color: white;
      border: none;
      cursor: pointer;
    }
    .keyboard button.backspace { background-color: #f4c542; color: #8B4513; }
    .keyboard button:hover { background-color: #3a1f00; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
    .keyboard button.key-disabled { background-color: #d2a679 !important; cursor: not-allowed; }
    .keyboard button.key-disabled:hover { box-shadow: none; background-color: #d2a679 !important; }

    .image-input-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 74px;
    }
/* ===== Top bar: Set 選單 + Go ===== */
.topbar{
  display:flex;
  align-items:center;
  gap:8px;
margin-bottom: 10px;
}
#topSetSelect {
  margin-top: 13px; /* ↓ 可微調 */
}
#goBtn {
  margin-top: 4px; /* ↓ 令兩個更齊 */
}

.ui-ctrl{
  height: 38px;
  line-height: 38px;
  font-size: 16px;
  padding: 0 10px;
  color:#8B4513;
  background:#fff;
  border:1px solid #cfcfcf;
  border-radius: 0;               /* ❗非圓角 */
}
#topSetSelect.ui-ctrl{ width: 160px; }
#goBtn{
  min-width: 64px;
  padding: 0 14px;
  background:#8B4513;             /* 啡底白字 */
  color:#fff;
  border: none;
  border-radius: 0;               /* ❗非圓角 */
  cursor:pointer;
  height:38px;
}
#goBtn:hover{ background:#5f3418; box-shadow:0 0 6px rgba(95,52,24,.35); }

/* 讓整條 topbar 與畫面其他元素對齊 */
.header-row{ display:flex; flex-direction:column; }

    .image-container { width: 570px; height: 390px; position: relative; }
    .word-hint{
      position: absolute; left: 10px; bottom: 10px; padding: 4px 8px;
      color: #8B4513; font-size: 22px; line-height: 1.1; background: transparent;
      pointer-events: none; z-index: 2;
    }

    #wordImage { width: 100%; height: 100%; object-fit: contain; display: block; }
    #wordImage.placeholder{ background:#fff; }

    #soundBtn {
      position: absolute; bottom: 0; right: 0;
      background: none; border: none; padding: 0; cursor: pointer;
    }
    #soundBtn img { width: 50px; height: auto; transition: filter 0.25s ease; }
    #soundBtn:hover img { filter: brightness(1.2); }

    #stick {
      width: 300px; height: 470px; margin-top: 10px; transform-origin: top center;
    }

    /* 物理鍵盤提示覆蓋層 */
    #kbdHint{
      position: absolute;
      inset: 0;                     /* 充滿整個 inputContainer */
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;         /* 不阻擋點擊 */
    }
    #kbdHint span{
      width: 80%;
      text-align: center;
      color: rgba(0,0,0,.38);       /* 淺灰 */
      font-weight: 500;
      line-height: 1.25;
      /* 細啲，而且會跟容器自適應 */
      font-size: clamp(12px, 2.2vw, 18px);
    }

    .input-row { display: flex; align-items: flex-start; gap: 12px; }

    .attempt-box {
      display: none; background-color: transparent; color: #8B4513;
      font-size: 270%; font-weight: normal; padding: 5px; margin-top: 10px; text-align: center;
    }
    #attemptList {
      list-style: none; padding: 0; margin: 0; display: grid;
      grid-template-columns: repeat(3, 1fr); grid-auto-rows: auto; row-gap: 6px; column-gap: 10px;
    }
    #attemptList li { text-decoration: line-through; opacity: 0.9; }

    .big-tick {
      position: absolute; font-size: 120px; color: #22c55e; opacity: 0;
      transform: translate(0, -20px) scale(0.8);
      transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; z-index: 500;
    }
    .big-tick.show { opacity: 1; transform: translate(0, -20px) scale(1); }

    .input-container { width: 570px; position: relative; text-align: center; }

    #lessonLabel {
      font-size: 24px; font-weight: bold; color: #5a3e2b; text-align: center; margin-top: 10px;
    }

    #inputBox {
      width: 564px; height: 160px; font-size: 100px; text-align: center; color: #8B4513;
      border: 2px solid #888; background-color: rgba(255,255,255,0.5);
    }

    .input-box {
      width: 100px; height: 100px; color: #8B4513; font-size: 64px; text-align: center;
      margin: 5px; border: 2px solid #888; background-color: rgba(255, 255, 255, 0.5); box-sizing: border-box;
    }
    .input-box.locked { color: #8B4513; }
    .split-input-group { display: inline-flex; justify-content: center; margin-top: 20px; }

    #submitBtn {
      margin-top: 10px; font-size: 20px; padding: 8px 16px; background-color: #20B2AA;
      color: white; border: none; position: relative; transition: background-color 0.25s ease;
    }
    #submitBtn:hover { background-color: #008080; transform: scale(1.05); box-shadow: 0 0 10px rgba(0, 128, 128, 0.6); }

    #stick-container { text-align: center; margin-top: 74px; }

    #scoreDisplay { color: #8B4513; font-size: 28px; font-weight: bold; margin-bottom: 5px; }
    #scorePopup { position: absolute; right: -100px; top: 0; font-size: 60px; color: #8B4513; opacity: 0; pointer-events: none; }

    .showPopup { animation: floatUp 1.2s ease-out forwards; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-120px); } }

    #gameOverOverlay {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background-color: rgba(139, 69, 19, 0.8); color: white; font-size: 64px;
      padding: 40px 80px; border-radius: 20px; display: none; z-index: 1000; text-align: center;
    }
    #finishOverlay {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background-color: rgba(139, 69, 19, 0.9); color: #fff; font-size: 64px;
      padding: 40px 80px; border-radius: 20px; display: none; z-index: 1000; text-align: center;
      max-height: none; overflow: visible;
    }
    #finishOverlay .hint { display: block; font-size: 20px; margin-top: 12px; opacity: 0.9; }

    #tryAgainBtn {
      display: block; margin-top: 20px; font-size: 24px; padding: 10px 20px;
      background-color: white; color: #8B4513; border: none; cursor: pointer;
    }

    #attemptsSummary { margin-top: 16px; font-size: 18px; text-align: left; max-height: none; overflow: visible; }
    #attemptsSummary ul { list-style: none; padding: 0; margin: 0; }
    #attemptsSummary li { display: flex; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.25); }
    #attemptsSummary .word { min-width: 120px; font-weight: 600; }
    #attemptsSummary .attempt { opacity: 0.95; }
    #attemptsSummary .cross-icon { font-size: 22px; color: #FF0000; }

    #setSelect{ display:block; margin: 0 auto 10px; text-align:center; }

    #hintOverlay{
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      z-index: 1500; background: rgba(139, 69, 19, 0.8); pointer-events: auto;
    }
    .hint-card{
      position: relative; width: 800px; max-width: 90vw; aspect-ratio: 4 / 3;
      display: flex; align-items: center; justify-content: center;
    }
    #hintText{
      position: absolute; left: 50%; transform: translateX(-50%); width: 88%;
      color: rgb(139, 69, 19); -webkit-text-stroke: 0.5px rgba(0,0,0,0.25);
      font-size: clamp(10px, 2.2vw, 25px); line-height: 1.35; text-align: center; z-index: 2;
    }
    .hint-actions{
      position: absolute; left: 6%; transform: translateX(-45%); bottom: 40%;
      display: flex; gap: 24px; align-items: center; justify-content: center; z-index: 2;
    }
    .hint-btn{ background: none; border: none; padding: 0; cursor: pointer; }
    .hint-btn img{ width: 28px; height: auto; filter: drop-shadow(0 0 2px rgba(0,0,0,0.3)); transition: filter 0.25s ease; }
    .hint-btn:hover img { transform: rotate(90deg) scale(1.2); filter: brightness(1.2); }
    .hint-bg{ position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 1; }

    /* --- Mobile tip overlay --- */
    #rotateHint{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      pointer-events: none;
    }
#wordImage.placeholder {
  background: #fff;
}

    #rotateHint .msg{
      width: 90vw;
      text-align: center;
      color: #fff;
      font-weight: 900;
      line-height: 1.15;
      font-size: clamp(22px, 9vw, 56px);
      text-shadow:
        0 0 8px rgba(0,0,0,.75),
        0 0 18px rgba(0,0,0,.55);
      animation: rotateHintFlash 1.1s ease-in-out infinite;
    }
    @keyframes rotateHintFlash{
      0%,100% { opacity: .95; transform: scale(1); }
      50%     { opacity: .7;  transform: scale(1.02); }
    }


    /* ✅ 防止 split 輸入格文字在不同裝置被截斷／溢出 */
    .split-input-group .input-box {
      padding: 0;
      overflow: hidden;
      vertical-align: middle;
      -webkit-text-size-adjust: 100%;
    }
  </style>
</head>
<body>
  <div class="stage-outer">
    <div class="container">
      <div class="game-row">
<div class="left-panel">
  <div class="header-row">
    <div class="topbar">
      <select id="topSetSelect" class="ui-ctrl">
        <!-- 1–25 -->
        <option value="" selected disabled>Select Set</option>
        <script>
          document.write([...Array(25)].map((_,i)=>`<option value="${i+1}">Set ${i+1}</option>`).join(''));
        </script>
      </select>
      <button id="goBtn" onclick="handleGo()">Go</button>
    </div>
  </div>

  <div class="label">Consonants</div>
  <div class="keyboard" id="consonantKeys"></div>
  <div class="label">Vowels</div>
  <div class="keyboard" id="vowelKeys"></div>
</div>

        <div class="image-input-wrapper">
          <div class="image-container">
            <div id="blankImage"></div>
            <img id="wordImage" src="" alt="">
            <div id="wordHint" class="word-hint"></div>
            <button id="soundBtn" onclick="playAudio()">
              <img src="speaker.png" alt="Play Sound">
            </button>
          </div>

          <div class="input-row">
            <div class="input-container" id="inputContainer">
              <input type="text" id="inputBox" readonly />
              <div id="scorePopup">+10</div>
            </div>
          </div>

          <button id="submitBtn" data-mode="submit" onclick="submitAnswer()">submit</button>
        </div>

        <div id="stick-container">
          <div id="finishOverlay">
            Finish!
            <div id="attemptsSummary"></div>
          </div>
          <img id="stick" src="stick1.png" alt="stickman">
          <div class="attempt-box" id="attemptBox">
            <ul id="attemptList"></ul>
          </div>
        </div>
      </div>

      <audio id="audio" src=""></audio>
      <audio id="winSound" src="win.mp3"></audio>
      <audio id="clickSound" src="click.mp3"></audio>
      <audio id="missSound" src="scratch.mp3"></audio>
      <audio id="screamSound" src="scream.mp3"></audio>
    </div>
  </div>

  <!-- Hint Overlay -->
  <div id="hintOverlay">
    <div class="hint-card">
      <img class="hint-bg" src="hints.png" alt="hints">
      <div id="hintText"></div>
      <div class="hint-actions">
        <button class="hint-btn" id="hintCloseBtn" aria-label="Close hint">
          <img src="cross.png" alt="Close">
        </button>
      </div>
    </div>
    <audio id="hintAudio"></audio>
  </div>

  <!-- Rotate/Hints overlay -->
  <div id="rotateHint">
    <div class="msg">please turn your phone sideways to play</div>
  </div>

  <script>
/* =================== 資料 =================== */
const wordSets = {
  1:[{word:"cub",hint:{text:"如果/k/ 在前是 c ,/k/ 在後是 k <br>因為國王好老了在後面慢慢行, 貓就在前面跑<br> e.g.  cook, crook",audio:"audio/cub_hints.mp3"}},{word:"gun"},{word:"mop"},{word:"sim"},{word:"ted"},{word:"rag"},{word:"cot"}],
  2:[{word:"silk",disabled:["c"],hint:{text:"一個音的字, 如果聽到/l/音,<br> 是 l 不是 o , 因為 o 是讀/o/<br>e.g. milk, sell",audio:"audio/silk_hints.mp3"}},{word:"loft"},{word:"vent"},{word:"melt"},{word:"gasp"},{word:"busk"}],
  3:[{word:"drop",hint:{text:"d r 讀快些好像 j <br>j 比較清和簡單, d r 聽上來有些變化的<br>e.g. jam 同 dram ",audio:"audio/drop_hints.mp3"}},{word:"trim",hint:{text:"t r 讀快些拼出來好像 ch<br>ch 比較清和簡單, t r 聽上來有些變化的<br>e.g. train 同 chain ",audio:"audio/trim_hints.mp3"}},{word:"flip"},{word:"drug"},{word:"blog"},{word:"trap"},{word:"crab"},{word:"brim"}],
  4:[{word:"truck",hint:{text:"a e i o u 後有 /k/音, 國王帶貓跟小朋友玩,<br>所以是 ck, 小朋友後盡量多些人<br>e.g. lock, duck ",audio:"audio/truck_hints.mp3"}},{word:"dock"},{word:"lack"},{word:"yuck"},{word:"flock"},{word:"slack"}],
  5:[{word:"mesh"},{word:"shock"},{word:"slosh"},{word:"shack"}],
  6:[{word:"mulch"},{word:"pitch"},{word:"etch"},{word:"chock"}],
  7:[{word:"cloth",disabled:["f"]},{word:"thrum",disabled:["f"]},{word:"broth",disabled:["f"]}],
  8:[{word:"scab",hint:{text:"sg, sb, sd 不會在一起<br>要用 sc, sp, st 蛇嚇到人的故事取代<br>e.g stop, spin, scan ",audio:"audio/scab_hints.mp3"}},{word:"stench"},{word:"stitch"},{word:"span"},{word:"scotch"},{word:"splash"}],
  9:[{word:"wig",disabled:["e"]},{word:"fix"},{word:"slick"},{word:"fig",disabled:["e"]},{word:"critic",hint:{text:"之前講過aeiou後如有/k/音是ck<br>但如果該字有兩個音節以上,尾音是ic 就不用加k<br>e.g music, comic ",audio:"audio/critic_hints.mp3"}},{word:"public"}],
  10:[{word:"chime",disabled:["g"]},{word:"wipe"},{word:"clade",disabled:["i"]},{word:"spine",disabled:["g"]},{word:"gripe"},{word:"gape",disabled:["i"]},{word:"steve",disabled:["a","i"]},{word:"mule",disabled:["w"]},{word:"dose",disabled:["a","w"]},{word:"fuse",disabled:["w"]},{word:"phase",disabled:["f","i"]}],
  11:[{word:"think",disabled:["f"]},{word:"bring"},{word:"cling"},{word:"stink"},{word:"shrink"},{word:"drink"}],
  12:[{word:"quake",disabled:["i"],hint:{text:"如果聽到/kw/ 音是qu, 沒有kw的",audio:"audio/quake_hints.mp3"}},{word:"quench"},{word:"quick"},{word:"quote",disabled:["w","a"]},{word:"quite",disabled:["g"]}],
  13:[{word:"sheaf",disabled:["i"]},{word:"flea",disabled:["i"]},{word:"thief",disabled:["a"]},{word:"sweat",hint:{text:"如果聽到/e/ 音, 除e外還有ea",audio:"audio/sweat_hints.mp3"}},{word:"death"},{word:"preen",disabled:["a","i"]},{word:"shield",disabled:["a"]},{word:"chief",disabled:["a"]},{word:"flue",disabled:["o","w"]}],
  14:[{word:"birch",disabled:["e","u"]},{word:"derv",disabled:["i","u"]},{word:"stir",disabled:["e","u"]},{word:"thorn",disabled:["a"]},{word:"scorn",disabled:["a"]},{word:"mirth",disabled:["e","u"]},{word:"shirk",disabled:["e","u"]},{word:"quirk",disabled:["e"]}],
  15:[{word:"stew"},{word:"spew"},{word:"fume",disabled:["w"]}],
  16:[{word:"soy",hint:{text:"跳高故事ai,ei,oi,ay,ey,oy 因為Ivanman不喜歡在最尾<br>放在中間是ai,ei,oi  放最尾是ay,ey,oy<br>e.g. toy,soil,play,rain",audio:"audio/soy_hints.mp3"}},{word:"dray",disabled:["e"]},{word:"coil"},{word:"troy"},{word:"hoist"},{word:"spray",disabled:["e"]},{word:"quail",disabled:["e"]},{word:"stain",disabled:["e"]}],
  17:[{word:"launch",disabled:["o","w"]},{word:"prawn",disabled:["u","l","o"]},{word:"stalk",disabled:["o","w","u"]},{word:"spawn",disabled:["l","u","o"]},{word:"chalk",disabled:["o","w","u"]}],
  18:[{word:"coach",disabled:["w"]},{word:"scold",disabled:["w","a"]},{word:"shoal",disabled:["w"]},{word:"blind",disabled:["g"]},{word:"child",disabled:["g"]}],
  19:[{word:"scoot",disabled:["u"]},{word:"drown",disabled:["u"]},{word:"crow",disabled:["a"]},{word:"broom",disabled:["u"]},{word:"shoot",disabled:["u"]}],
  20:[{word:"tawny",disabled:["e","r","l","u"]},{word:"foamy",disabled:["e","w"]},{word:"faintly",disabled:["e"]},{word:"shonky",disabled:["e"]},{word:"twirly",disabled:["e","u"]}],
  21:[{word:"kerb",disabled:["i","u"],hint:{text:"之前話/k/音在前是c,在後是k<br>但如果第2個英文字母係i,y,e, c會變咗/s/<br>所以前面的/k/音就要用k<br>e.g. kiss , kettle",audio:"audio/kerb_hints.mp3"}},{word:"king"},{word:"kid"},{word:"kick"},{word:"keen",disabled:["a","i"]},{word:"kite",disabled:["g"]}],
  22:[{word:"victor",disabled:["e","a"]},{word:"orca",disabled:["w","l","u"]},{word:"mower",disabled:["a"]},{word:"dower",disabled:["u","a"]},{word:"fauna",disabled:["o","l","w","e"]},{word:"shiver",disabled:["a","o"]}],
  23:[{word:"portion",disabled:["s","a"]},{word:"fiction",disabled:["s"]},{word:"incursion",disabled:["e","t"]},{word:"caution",disabled:["w","r","l","s"]}],
  24:[{word:"shadow",disabled:["l"]},{word:"indigo",disabled:["l","w"]},{word:"bronco",disabled:["l","w"]},{word:"widow",disabled:["l"]},{word:"jungle",disabled:["o","a"]},{word:"doodle",disabled:["u","w"]},{word:"beadle",disabled:["i","w","o"]},{word:"burgle",disabled:["i","o"]},{word:"travel",disabled:["o"]},{word:"coastal",disabled:["e","w"]},{word:"kernel",disabled:["a","i","u"]}],
  25:[{word:"hospitality"},{word:"calendar",disabled:["u","o"]},{word:"adventure",disabled:["o"]},{word:"disaster",disabled:["o"]},{word:"tradition",disabled:["s","e","u"]},{word:"phenomenon",disabled:["u","f","a"]},{word:"philosophy",disabled:["u","a","e","f"]}]
};

const meanings = {
  cub:"幼獸",gun:"槍",mop:"拖把",sim:"模擬",ted:"熊",rag:"抹布",cot:"小床",
  silk:"絲綢",loft:"閣樓",vent:"通風口",melt:"融化",gasp:"倒抽一口氣",busk:"街頭表演",
  drop:"掉落",trim:"修剪",flip:"翻轉",drug:"藥物",blog:"部落格",trap:"陷阱",crab:"螃蟹",brim:"邊緣",
  truck:"貨車",dock:"碼頭",lack:"缺乏",yuck:"噁心",flock:"群",slack:"鬆弛",
  mesh:"網狀物",shock:"震驚",slosh:"濺起",shack:"簡陋小屋",
  mulch:"覆蓋物",pitch:"球場",etch:"蝕刻",chock:"塞住",
  cloth:"布料",thrum:"低沉嗡聲",broth:"肉湯",
  scab:"結痂",stench:"惡臭",stitch:"縫合",span:"跨度",scotch:"蘇格蘭的",splash:"濺起",
  wig:"假髮",fix:"修理",slick:"圓滑的",fig:"無花果",critic:"評論家",public:"公眾/公共的",
  chime:"風鈴",wipe:"擦拭",clade:"演化支",spine:"脊柱",gripe:"抱怨",gape:"目瞪口呆",steve:"人名",mule:"騾子",dose:"劑量",fuse:"保險絲",phase:"階段",
  think:"思考",bring:"帶來",cling:"緊貼/依附",stink:"發臭",shrink:"收縮",drink:"喝/飲料",
  quake:"地震",quench:"解渴",quick:"快速",quote:"引述",quite:"相當",
  sheaf:"一束",flea:"跳蚤",thief:"小偷",sweat:"汗水",death:"死亡",preen:"整理羽毛",shield:"盾牌",chief:"首領",flue:"煙道",
  birch:"樺木",derv:"柴油",stir:"攪拌",thorn:"荊棘",scorn:"鄙視",mirth:"歡笑",shirk:"逃避",quirk:"怪癖",
  stew:"燉菜",spew:"噴出",fume:"冒煙",
  soy:"大豆",dray:"運貨平板車",coil:"線圈/盤繞",troy:"特洛伊",hoist:"吊起",spray:"噴霧",quail:"鵪鶉",stain:"污漬",
  launch:"發射",prawn:"明蝦",stalk:"莖",spawn:"產卵",chalk:"粉筆",
  coach:"長途巴士",scold:"責罵",shoal:"淺灘",blind:"失明",child:"孩子",
  scoot:"疾走",drown:"溺水",crow:"烏鴉",broom:"掃帚",shoot:"射擊",
  tawny:"黃褐色的",foamy:"起泡的",faintly:"微弱地",shonky:"粗劣的",twirly:"旋轉的",
  kerb:"路邊石",king:"國王",kid:"小孩",kick:"踢",keen:"熱切",kite:"風箏",
  victor:"勝利者",orca:"虎鯨",mower:"割草機",dower:"嫁妝",fauna:"動物群",shiver:"發抖",
  portion:"部分",fiction:"小說",incursion:"入侵",caution:"警示",
  shadow:"影子",indigo:"靛藍色",bronco:"野馬",widow:"寡婦",jungle:"叢林",doodle:"塗鴉",beadle:"教堂司事",burgle:"入室行竊",travel:"旅行",coastal:"沿海的",kernel:"穀粒",
  hospitality:"好客",calendar:"日曆",adventure:"冒險",disaster:"災難",tradition:"傳統",phenomenon:"現象",philosophy:"哲學"
};

/* =================== 狀態 =================== */
let currentSet = null;
let hintPlayTimer = null;
const BLANK_IMG = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMB/axwQX0AAAAASUVORK5CYII=';
let audioDelayTimer = null;
let currentIndex = 0, score = 0, mistakeCount = 0, gameOver = false, useSplitInputs = false;
let wrongAttempts = 0, awaitingNext = false, attemptsLog = [], nextAudioIndex = 1;
let wrongGuesses = [], isHintOpen = false, firstPlayRequired = true, playStarted = false;
let disabledLetters = new Set();

/* =================== 初始 =================== */
function initGame() {
  const consonants = ['b','c','d','f','g','h','j','k','l','m','n','p','q','r','s','t','v','w','x','y','z'];
  const vowels = ['a','e','i','o','u'];
  const consonantContainer = document.getElementById("consonantKeys");
  const vowelContainer = document.getElementById("vowelKeys");
  [consonantContainer, vowelContainer].forEach(c => c.innerHTML = '');
  for (let i = 0; i < consonants.length; i += 3) {
    consonants.slice(i, i + 3).forEach(ch => consonantContainer.appendChild(createButton(ch)));
  }
  [['a','e','i'], ['o','u','←']].forEach(row => {
    row.forEach(ch => {
      const btn = createButton(ch);
      if (ch === '←') btn.classList.add('backspace');
      vowelContainer.appendChild(btn);
    });
  });
  currentSet = null;
  setBlankState();
  const miss = document.getElementById('missSound'); if (miss) miss.volume = 0.25;
}

/* =================== UI/輸入 =================== */
function createButton(char) {
  const btn = document.createElement("button");
  btn.textContent = char;
  btn.dataset.letter = char;
  if (char === '←') btn.classList.add('backspace');
  btn.onclick = () => insertChar(char);
  return btn;
}

function insertChar(char){
  dismissKbdHint();
  if (!playStarted || isHintOpen || gameOver) return;

  if (char !== '←' && disabledLetters.has(char)) return;

  const click = document.getElementById("clickSound");
  try { click && click.play(); } catch(e){}

  if (!useSplitInputs) {
    const input = document.getElementById("inputBox");
    if (!input) return;
    if (char === '←') {
      input.value = input.value.slice(0, -1);
    } else {
      input.value += char;
    }
  } else {
    const inputs = document.querySelectorAll(".input-box");
    if (char === '←') {
      for (let i = inputs.length - 1; i >= 0; i--) {
        if (!inputs[i].classList.contains("locked") && inputs[i].value) {
          inputs[i].value = '';
          break;
        }
      }
    } else {
      for (let i = 0; i < inputs.length; i++) {
        if (!inputs[i].classList.contains("locked") && !inputs[i].value) {
          inputs[i].value = char;
          break;
        }
      }
    }
  }
}

/* ====== 物理鍵盤提示（Play 後一次） ====== */
const KBD_HINT_KEY = 'kbdHintDismissed_v1';

function mountKbdHint() {
  if (sessionStorage.getItem(KBD_HINT_KEY)) return;
  if (useSplitInputs) return;
  const host = document.getElementById('inputContainer');
  if (!host || document.getElementById('kbdHint')) return;
  const wrap = document.createElement('div');
  wrap.id = 'kbdHint';
  wrap.innerHTML = `<span>You can also use your physical keyboard to type.</span>`;
  host.appendChild(wrap);
}

function dismissKbdHint() {
  const el = document.getElementById('kbdHint');
  if (el) el.remove();
  sessionStorage.setItem(KBD_HINT_KEY, '1');
}

/* =================== 遊戲流程 =================== */
function switchSet(setNum){
  if (!setNum){
    currentSet = null; hideHint(); setBlankState(); return;
  }
  hideHint();
  const overlay = document.getElementById('finishOverlay'); if (overlay) overlay.style.display = 'none';
  const summary = document.getElementById('attemptsSummary'); if (summary) summary.innerHTML = '';
  const btn = document.getElementById('submitBtn');
  if (btn){ btn.textContent = 'submit'; btn.dataset.mode = 'submit'; btn.style.backgroundColor = '#20B2AA'; btn.onclick = submitAnswer; }
  wrongGuesses = []; renderAttemptsBox();

  currentSet = parseInt(setNum, 10);
  currentIndex = 0; mistakeCount = 0; wrongAttempts = 0; useSplitInputs = false; gameOver = false;
  attemptsLog = new Array(wordSets[currentSet].length).fill(null);

  updateStickImage(true);
  updateWord();
  resetInput(wordSets[currentSet][currentIndex].word.length);

  const popup = document.getElementById("scorePopup");
  if (popup){ popup.classList.remove("showPopup"); popup.style.opacity="0"; popup.textContent="+10"; }
}

function updateWord() {
  const wordObj = wordSets[currentSet]?.[currentIndex];
  const img   = document.getElementById("wordImage");
  const hintBox = document.getElementById("wordHint");
  const blank = document.getElementById("blankImage");

  enableAllKeys();

  if (!wordObj) {
    img.src = ""; img.classList.add("placeholder"); img.style.display = "none";
    if (blank) blank.style.display = "block";
    if (hintBox) hintBox.style.display = "none";
    return;
  }

  img.classList.remove("placeholder"); img.style.display = "block";
  if (blank) blank.style.display = "none";
  img.src = `images/${wordObj.word}.png`;

  if (Array.isArray(wordObj.disabled) && wordObj.disabled.length > 0) applyDisabledLetters(wordObj.disabled);

  const zh = (wordObj.meaning) || meanings[wordObj.word];
  if (hintBox) {
    const total = wordSets[currentSet]?.length || 0;
    const current = currentIndex + 1;
    hintBox.textContent = zh ? `${current}/${total}  ${zh}` : `${current}/${total}`;
    hintBox.style.display = "block";
  }

  if (wordObj.hint) {
    if (firstPlayRequired && currentIndex === 0) hideHint(); else showHint(wordObj.hint);
  } else hideHint();
}

let isTransitioning = false;
function showGreenTick() {
  let tick = document.getElementById('bigTick');
  const input = document.getElementById('inputContainer');
  if (!tick) {
    tick = document.createElement('span');
    tick.id = 'bigTick'; tick.className = 'big-tick'; tick.textContent = '✓';
    input.style.position = 'relative'; input.appendChild(tick);
  }
  tick.style.right = '-80px'; tick.style.top = '40px';
  requestAnimationFrame(() => tick.classList.add('show'));
}
function hideGreenTick(){ const tick = document.getElementById('bigTick'); if (tick) tick.classList.remove('show'); }

function playAudio() {
  if (!playStarted || isHintOpen) return;
  const word = wordSets[currentSet]?.[currentIndex]?.word; if (!word) return;
  const audioEl = document.getElementById("audio"); if (!audioEl) return;
  try{
    audioEl.src = `audio/${word}${nextAudioIndex}.mp3`;
    audioEl.currentTime = 0; audioEl.play();
    nextAudioIndex = (nextAudioIndex === 1) ? 2 : 1;
  }catch(e){}
}

function submitAnswer() {
  if (gameOver || isHintOpen) return;

  const setWords = wordSets[currentSet];
  const correctWord = setWords[currentIndex].word;
  let guess = '';

  if (!useSplitInputs) {
    document.getElementById("clickSound").play();
    const input = document.getElementById("inputBox").value.toLowerCase();
    if (!input) return; guess = input;
  } else {
    document.getElementById("clickSound").play();
    const inputs = document.querySelectorAll(".input-box");
    const values = Array.from(inputs).map(inp => (inp.value || '').toLowerCase());
    if (values.every(v => v === '')) return;
    guess = values.join('');
  }

  if (guess === correctWord) {
    if (isTransitioning) return; isTransitioning = true;
    const attemptsThisRound = wrongAttempts + 1;
    attemptsLog[currentIndex] = { attempts: attemptsThisRound, revealed: false };
    mistakeCount = 0; wrongAttempts = 0; showGreenTick();
    const isLast = (currentIndex === setWords.length - 1);
    setTimeout(() => {
      hideGreenTick();
      if (isLast) showFinish(); else nextWord();
      isTransitioning = false;
    }, 1200);
    return;
  }

  document.getElementById("missSound").play();
  mistakeCount++; wrongAttempts++; updateStickImage();
  wrongGuesses.push(guess); renderAttemptsBox();

  if (!useSplitInputs && wrongAttempts >= 1) {
    useSplitInputs = true; resetInput(correctWord.length); return;
  }

  if (useSplitInputs) {
    const inputs = document.querySelectorAll(".input-box");
    for (let i = 0; i < correctWord.length; i++) {
      if ((inputs[i].value || '').toLowerCase() === correctWord[i]) {
        inputs[i].classList.add('locked'); inputs[i].value = correctWord[i];
      } else { inputs[i].value = ''; inputs[i].classList.remove('locked'); }
    }
  }

  if (mistakeCount >= 6) {
    if (!useSplitInputs) { useSplitInputs = true; resetInput(correctWord.length); }
    attemptsLog[currentIndex] = { attempts: 6, revealed: true };
    const inputs = document.querySelectorAll(".input-box");
    for (let i = 0; i < correctWord.length; i++) {
      inputs[i].value = correctWord[i]; inputs[i].style.color = '#FF0000'; inputs[i].classList.add('locked');
    }
    document.getElementById("screamSound").play();
    const btn = document.getElementById("submitBtn");
    btn.textContent = "Next";
    btn.dataset.mode = "next";
    btn.style.backgroundColor = "#FF0000";
    const isLast = (currentIndex === setWords.length - 1);
    btn.onclick = () => {
      btn.textContent = "submit";
      btn.dataset.mode = "submit";
      btn.style.backgroundColor = "#20B2AA";
      btn.onclick = submitAnswer;
      mistakeCount = 0; wrongAttempts = 0;
      if (isLast) showFinish(); else nextWord();
    };
    return;
  }

  if (!useSplitInputs) document.getElementById("inputBox").value = "";
}

function showHint(hintObj) {
  isHintOpen = true;
  const ov = document.getElementById('hintOverlay');
  const txt = document.getElementById('hintText');
  const closeBtn = document.getElementById('hintCloseBtn');
  const hintAudio = document.getElementById('hintAudio');
  if (!ov || !txt || !hintAudio || !closeBtn) return;

  txt.innerHTML = (hintObj?.text || '').replace(/\n/g, '<br>');

  const w = wordSets[currentSet][currentIndex].word;
  hintAudio.src = hintObj?.audio || `audio/${w}_hints.mp3`;
  hintAudio.currentTime = 0; try { hintAudio.load?.(); } catch (e) {}
  closeBtn.onclick = () => hideHint();
  ov.style.display = 'flex';

  const tryPlay = () => {
    if (!isHintOpen) return;
    hintAudio.play().catch(() => {
      const unlock = () => {
        if (!isHintOpen) return;
        hintAudio.play().finally(() => {
          window.removeEventListener('pointerdown', unlock);
          window.removeEventListener('keydown', unlock);
        });
      };
      window.addEventListener('pointerdown', unlock, { once: true });
      window.addEventListener('keydown', unlock, { once: true });
    });
  };
  if (hintPlayTimer) clearTimeout(hintPlayTimer);
  hintPlayTimer = setTimeout(tryPlay, 400);
}

function handleGo(){
  // 讀取選中的 set（若未選就默認 1）
  const sel = document.getElementById('topSetSelect');
  const chosen = parseInt(sel?.value || '1', 10);

  switchSet(chosen);     // 載入該 set（第 1 題）
  playStarted = true;    // 立即開始
  firstPlayRequired = false;

  // 如果首題有教學提示就打開；同時顯示一次鍵盤提示
  const obj = wordSets[currentSet]?.[currentIndex];
  if (obj?.hint) showHint(obj.hint);
  mountKbdHint();
}


function hideHint() {
  isHintOpen = false;
  if (hintPlayTimer) clearTimeout(hintPlayTimer); hintPlayTimer = null;
  const hintAudio = document.getElementById('hintAudio');
  if (hintAudio) { try { hintAudio.pause(); hintAudio.currentTime = 0; hintAudio.src = ''; } catch (e) {} }
  const ov = document.getElementById('hintOverlay'); if (ov) ov.style.display = 'none';
}

function setBlankState() {
  const img = document.getElementById('wordImage');
  const blank = document.getElementById('blankImage');
if (img) {
  // 使用 1x1 白色 PNG，避免出現破圖 icon
  img.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMB/axwQX0AAAAASUVORK5CYII=';

  img.style.display = 'block';
  img.classList.add('placeholder');
  img.style.background = '#fff';
}
if (blank) blank.style.display = 'none';
  const input = document.getElementById("inputBox"); if (input) input.value = "";
  const overlay = document.getElementById('finishOverlay'); if (overlay) overlay.style.display = 'none';
  const summary = document.getElementById('attemptsSummary'); if (summary) summary.innerHTML = '';
  const mainAudio = document.getElementById('audio'); try { if (mainAudio) { mainAudio.pause(); mainAudio.currentTime = 0; } } catch(e){}
  enableAllKeys();
}

function buildFinishSummary() {
  const setWords = wordSets[currentSet];
  const box = document.getElementById('attemptsSummary'); if (!box) return;
  let html = '<ul>';
  for (let i = 0; i < setWords.length; i++) {
    const w = setWords[i].word; const entry = attemptsLog[i];
    let rightPart = '';
    if (!entry) rightPart = '<span class="attempt">–</span>';
    else if (entry.revealed) rightPart = '<span class="cross-icon">❌</span>';
    else rightPart = `<span class="attempt">attempts: ${entry.attempts}</span>`;
    html += `<li><span class="word">${w}</span>${rightPart}</li>`;
  }
  html += '</ul>'; box.innerHTML = html;
}

function renderAttemptsBox() {
  const box = document.getElementById('attemptBox');
  const list = document.getElementById('attemptList'); if (!box || !list) return;
  if (wrongGuesses.length === 0) { box.style.display = 'none'; list.innerHTML = ''; return; }
  box.style.display = 'block';
  list.innerHTML = wrongGuesses.slice(0, 6).map(g => `<li>${g}</li>`).join('');
}

function showFinish() {
  buildFinishSummary(); document.getElementById("finishOverlay").style.display = "block"; gameOver = true;
  const win = document.getElementById("winSound");
  if (win) { try { win.volume = 0.08; win.currentTime = 0; win.play(); } catch(e){} }
}

function handleNextAfterReveal() {
  const btn = document.getElementById("submitBtn");
  btn.textContent = "submit"; btn.dataset.mode = "submit"; btn.style.backgroundColor = "#20B2AA"; btn.onclick = submitAnswer;
  mistakeCount = 0; wrongAttempts = 0; nextWord();
}

function getScoreByAttempts(attempts) {
  if (attempts === 0) return 100;
  if (attempts === 1) return 90;
  if (attempts === 2) return 80;
  if (attempts === 3 || attempts === 4) return 70;
  if (attempts === 5) return 60;
  return 50;
}

function updateScore() {
  const el = document.getElementById("scoreDisplay");
  if (el) el.textContent = `Score: ${score}`;
}

function updateStickImage(reset = false) {
  const stick = document.getElementById("stick"); if (!stick) return;
  if (reset) { stick.src = "stick1.png"; stick.style.transform = "scale(1)"; return; }
  const imageNumber = Math.min(9, mistakeCount + 1);
  stick.src = `stick${imageNumber}.png`;
}

function nextWord() {
  hideHint();
  wrongGuesses = []; renderAttemptsBox();
  const setWords = wordSets[currentSet];
  if (currentIndex >= setWords.length - 1) { showFinish(); return; }
  currentIndex++;
  const nextWordObj = setWords[currentIndex];
  mistakeCount = 0; wrongAttempts = 0; useSplitInputs = false;
  const btn = document.getElementById('submitBtn');
  btn.textContent = 'submit'; btn.dataset.mode = 'submit'; btn.style.backgroundColor = '#20B2AA'; btn.onclick = submitAnswer;
  resetInput(nextWordObj.word.length); updateStickImage(true); updateWord();
}

function goNextAfterReveal() {
  awaitingNext = false;
  const btn = document.getElementById("submitBtn");
  btn.textContent = "submit"; btn.dataset.mode = "submit"; btn.style.backgroundColor = "#20B2AA"; btn.style.color = "#fff";
  nextWord();
}

function resetGame() {
  wrongGuesses = []; renderAttemptsBox();
  document.getElementById("gameOverOverlay").style.display = "none";
  document.getElementById("finishOverlay").style.display = "none";
  mistakeCount = 0; score = 0; wrongAttempts = 0; useSplitInputs = false; gameOver = false;
  updateScore(); updateStickImage(true);
  const currentWordObj = wordSets[currentSet][currentIndex];
  updateWord();
}

/* =================== 鍵盤限制 =================== */
function enableAllKeys() {
  disabledLetters.clear();
  document.querySelectorAll(".keyboard button").forEach(btn => {
    btn.disabled = false;
    btn.classList.remove("key-disabled");
  });
}

function applyDisabledLetters(letters = []) {
  disabledLetters = new Set(letters.map(l => l.toLowerCase()));
  document.querySelectorAll(".keyboard button").forEach(btn => {
    const ch = (btn.dataset.letter || "").toLowerCase();
    if (ch && ch !== "←" && disabledLetters.has(ch)) {
      btn.disabled = true;
      btn.classList.add("key-disabled");
    }
  });
}


/* ====== Rotate hint：只在手機直向第一次提示 ====== */
const ROTATE_HINT_KEY = 'rotateHintShown_v1';
function isMobilePortrait() {
  const isMobileUA = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
  const isPortrait = window.matchMedia('(orientation: portrait)').matches;
  return isMobileUA && isPortrait && window.innerWidth <= 820;
}
function showRotateHintOnce() {
  if (sessionStorage.getItem(ROTATE_HINT_KEY)) return;
  if (!isMobilePortrait()) return;
  const el = document.getElementById('rotateHint'); if (!el) return;
  el.style.display = 'flex';
  sessionStorage.setItem(ROTATE_HINT_KEY, '1');
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}
window.addEventListener('load', showRotateHintOnce);

/* ====== 重建輸入欄 ====== */
function resetInput(length) {
  const container = document.getElementById("inputContainer");
  const existingPopup = document.getElementById("scorePopup"); if (existingPopup) existingPopup.remove();
  container.innerHTML = '';

  const MAX_WIDTH = 564, MIN_BOX = 48, MAX_BOX = 120, TARGET_GAP = 8, MIN_GAP = 2;

  if (!useSplitInputs) {
    const input = document.createElement("input");
    input.id = "inputBox"; input.className = "input-box"; input.maxLength = length; input.readOnly = true;
    input.style.width = MAX_WIDTH + "px"; input.style.height = "160px"; input.style.fontSize = "100px";
    input.style.textAlign = "center"; input.style.color = "#8B4513"; input.style.border = "2px solid #888";
    input.style.backgroundColor = "rgba(255,255,255,0.5)"; input.style.margin = "0"; input.style.boxSizing = "border-box";
    /* 可選：讓大輸入框更穩定 */
    input.style.lineHeight = "160px";
    input.style.padding = "0";
    input.style.overflow = "hidden";
    container.appendChild(input);
  } else {
    const group = document.createElement("div");
    group.className = "split-input-group"; group.style.display = "inline-flex"; group.style.padding = "0"; group.style.boxSizing = "border-box";
    let gap = (length > 1) ? TARGET_GAP : 0;
    let per = Math.floor((MAX_WIDTH - gap * (length - 1)) / length);
    per = Math.max(MIN_BOX, Math.min(MAX_BOX, per));
    if (length > 1) {
      let maxGapThatFits = Math.floor((MAX_WIDTH - per * length) / (length - 1));
      gap = Math.max(MIN_GAP, Math.min(TARGET_GAP, maxGapThatFits));
      if (maxGapThatFits < MIN_GAP) { gap = MIN_GAP; per = Math.floor((MAX_WIDTH - gap * (length - 1)) / length); per = Math.max(24, per); }
    } else gap = 0;
    group.style.gap = gap + "px";

    const boxWidth  = per;
    const boxHeight = Math.round(per);
    const contentH  = Math.max(10, boxHeight - 4);           // 扣 2px 上下邊框
    const fontSize  = Math.floor(contentH * 0.74);           // 收斂比例，避免溢出

    for (let i = 0; i < length; i++) {
      const input = document.createElement("input");
      input.type = "text"; input.maxLength = 1; input.className = "input-box"; input.readOnly = true;

      input.style.width        = boxWidth + "px";
      input.style.height       = boxHeight + "px";
      input.style.fontSize     = fontSize + "px";
      input.style.lineHeight   = contentH + "px";            // 垂直置中且不溢出

      input.style.textAlign    = "center";
      input.style.border       = "2px solid #888";
      input.style.backgroundColor = "rgba(255,255,255,0.5)";
      input.style.color        = "#8B4513";
      input.style.margin       = "0";
      input.style.boxSizing    = "border-box";
      input.style.padding      = "0";
      input.style.overflow     = "hidden";

      group.appendChild(input);
    }
    container.appendChild(group);
  }

  const popup = existingPopup || (() => {
    const p = document.createElement("div");
    p.id = "scorePopup"; p.textContent = "+10"; p.style.position = "absolute"; p.style.right = "-100px"; p.style.top = "0";
    p.style.fontSize = "60px"; p.style.color = "#8B4513"; p.style.opacity = "0"; p.style.pointerEvents = "none"; return p;
  })();
  popup.classList.remove("showPopup");
  popup.style.opacity = "0";
  popup.textContent = "+10";
  container.appendChild(popup);

  // 顯示一次鍵盤提示
  mountKbdHint();
}

/* ====== 物理鍵盤事件（包含 Enter→Next） ====== */
function handlePhysicalKey(e){
  if (isHintOpen && e.key === 'Escape') { try{ hideHint(); }catch(_){} return; }
  if (!playStarted || gameOver) return;

  const k = e.key;

  if (k === 'Enter' || k === 'Backspace' || /^[a-z]$/i.test(k)) {
    dismissKbdHint();
  }

  if (k === 'Enter') {
    e.preventDefault();
    const btn = document.getElementById('submitBtn');
    if (!btn) return;
    const mode = (btn.dataset.mode || btn.textContent).toLowerCase();
    if (mode.includes('next')) {
      btn.click();           // 模擬 Next
    } else {
      submitAnswer();        // 提交
    }
    return;
  }

  if (k === 'Backspace') {
    e.preventDefault();
    insertChar('←');
    return;
  }

  if (/^[a-z]$/i.test(k)) {
    const ch = k.toLowerCase();
    insertChar(ch);
  }
}
window.addEventListener('keydown', handlePhysicalKey, { passive:false });

/* ====== 一次過設定所有音效音量（0~1） ====== */
function setSfxVolumes() {
  const click   = document.getElementById('clickSound');
  const miss    = document.getElementById('missSound');
  const win     = document.getElementById('winSound');
  const scream  = document.getElementById('screamSound');

  if (click)  click.volume  = 0.10;
  if (miss)   miss.volume   = 0.08;
  if (win)    win.volume    = 0.05;
  if (scream) scream.volume = 0.08;
}
window.addEventListener('load', setSfxVolumes);

/* ====== 固定版面縮放 ====== */
function fitStage(){
  const GAME_W = 1000, GAME_H = 720;
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const scale = Math.min(1, vw / GAME_W, vh / GAME_H);
  const stage = document.querySelector('.container');
  if (stage) stage.style.transform = `scale(${scale})`;
}
window.addEventListener('load', fitStage);
window.addEventListener('resize', fitStage);
window.addEventListener('orientationchange', fitStage);

/* ====== 啟動 ====== */
initGame();
  </script>
</body>
</html>
